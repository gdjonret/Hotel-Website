<!DOCTYPE html>
<html lang="fr">
<head>
    <%- include("../partials/head") %>
    <!-- Custom Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  
    <link rel="stylesheet" href="/css/flatpickr.css">
    <!-- Page specific CSS -->
    <link rel="stylesheet" href="/css/BookNow.css">
    <link rel="stylesheet" href="/css/progress-bar.css">
    <title>Book Now - Hotel Le Process</title>
</head>

<body>
    <%- include("../partials/navbar.ejs") %>

    <div class="room-image">
        <img src="/images/h1.jpg" alt="Standard Room">
    </div>

    <div class="container">
        <div class="steps">
            <div class="step">
                <span class="circle active">1</span>
                <p data-i18n="progress.selectRoom">SELECT ROOM</p>
            </div>
            <div class="step">
                <span class="circle">2</span>
                <p data-i18n="progress.guestDetails">BOOKING</p>
            </div>
            <div class="step">
                <span class="circle">3</span>
                <p data-i18n="progress.checkout">CHECKOUT</p>
            </div>
            <div class="step">
                <span class="circle">4</span>
                <p data-i18n="progress.confirmation">THANK YOU</p>
            </div>
            <div class="progress-bar">
                <span class="indicator"></span>
            </div>
        </div>
    
        <div class="row">
            <!-- Left Column: Date Picker -->
            <div class="col-md-4">
                <div class="booking-form-modern">
                    <form id="searchForm">
                        <div id="booking-warning" class="alert alert-danger" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i> Please fill in all required fields
                        </div>
                        
                        <!-- Check-in Card -->
                        <%
  function amenityKey(text) {
    if (!text) return 'amenityNames.unknown';
    const normalized = text
      .toLowerCase()
      .replace(/wi[\-\s]?fi/g, 'wifi')
      .replace(/[^a-z0-9]+/g, '_')
      .replace(/^_|_$/g, '');
    const safe = normalized.replace(/^[0-9]/, function (d) { return 'n_' + d; });
    return 'amenityNames.' + (safe || 'unknown');
  }
%>
                        <div class="booking-card">
                            <div class="card-label" data-i18n="bookNow.checkIn">CHECK-IN</div>
                            <div class="card-content">
                                <div class="card-date">
                                    <div class="card-value" id="checkin-display">14</div>
                                    <div class="card-month">Sep 2025</div>
                                </div>
                                <button class="card-dropdown" type="button">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                            <input type="text" id="checkin" class="hidden-input" placeholder="MM-DD-YYYY" required>
                        </div>
                        
                        <!-- Check-out Card -->
                        <div class="booking-card">
                            <div class="card-label" data-i18n="bookNow.checkOut">CHECK-OUT</div>
                            <div class="card-content">
                                <div class="card-date">
                                    <div class="card-value" id="checkout-display">15</div>
                                    <div class="card-month">Sep 2025</div>
                                </div>
                                <button class="card-dropdown" type="button">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                            <input type="text" id="checkout" class="hidden-input" placeholder="MM-DD-YYYY" required>
                        </div>
                        
                        <!-- Number of Adults Card -->
                        <div class="booking-card adults-card">
                            <div class="card-label" data-i18n="bookNow.numberOfAdults">NUMBER OF ADULTS</div>
                            <div class="card-content">
                                <div class="card-value" id="adults-display">1</div>
                                <div class="adults-steppers">
                                    <button class="card-dropdown" type="button">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                    <button class="card-dropdown" type="button">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                            <select id="adults" class="hidden-input" required>
                                <option value="" disabled>Select number of guests</option>
                                <option value="1" selected>1 Guest</option>
                                <option value="2">2 Guests</option>
                                <option value="3">3 Guests</option>
                                <option value="4">4 Guests</option>
                            </select>
                        </div>
                        
                        <!-- Check Rooms Button -->
                        <button type="submit" class="check-rooms-modern-btn">
                            <i class="fas fa-concierge-bell"></i>
                            <span data-i18n="bookNow.checkRooms">CHECK ROOMS</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right Column: Room Listings -->
            <div class="col-md-8">
                <div class="sorting-container">
                    <hr class="sorting-line">
                    <div class="sorting-dropdown">
                        <label for="sortOptions" data-i18n="bookNow.sortBy">Sort by:</label>
                        <select id="sortOptions" class="form-select" onchange="handleSortChange(this.value)">
                            <option value="default" data-i18n="bookNow.default">Default</option>
                            <option value="price-asc" data-i18n="bookNow.priceLowToHigh">Price: Low to High</option>
                            <option value="price-desc" data-i18n="bookNow.priceHighToLow">Price: High to Low</option>
                            <option value="availability" data-i18n="bookNow.availability">Availability</option>
                        </select>
                    </div>
                </div>

                <% if (typeof error !== 'undefined' && error) { %>
                    <div class="alert alert-danger" role="alert" style="margin: 20px 0; padding: 15px; background-color: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; color: #991b1b;">
                        <i class="fas fa-exclamation-circle"></i> <%= error %>
                    </div>
                <% } %>

                <% if (roomTypes && roomTypes.length > 0) { %>
                    <% roomTypes.forEach((roomType, index) => { 
                        // Parse detailed amenities JSON (for modal)
                        let equipment = [];
                        let amenities = [];
                        try {
                            if (roomType.amenitiesJson) {
                                const parsed = JSON.parse(roomType.amenitiesJson);
                                equipment = parsed.equipment || [];
                                amenities = parsed.amenities || [];
                            }
                        } catch (e) {
                            console.error('Error parsing amenities:', e);
                        }
                        
                        // Parse quick equipment (for room card)
                        let quickEquipment = [];
                        try {
                            if (roomType.quickEquipment) {
                                quickEquipment = JSON.parse(roomType.quickEquipment);
                            }
                        } catch (e) {
                            console.error('Error parsing quick equipment:', e);
                        }
                        
                        // Parse quick amenities (for room card)
                        let quickAmenities = [];
                        try {
                            if (roomType.quickAmenities) {
                                quickAmenities = JSON.parse(roomType.quickAmenities);
                            }
                        } catch (e) {
                            console.error('Error parsing quick amenities:', e);
                        }
                        
                        // Parse images JSON array
                        let roomImages = [];
                        try {
                            if (roomType.images) {
                                roomImages = JSON.parse(roomType.images);
                            }
                        } catch (e) {
                            console.error('Error parsing images:', e);
                        }

                        if ((!roomImages || roomImages.length === 0) && roomType.name) {
                            const normalizedName = roomType.name.trim().toLowerCase();
                            if (normalizedName === 'deluxe single') {
                                roomImages = [
                                    '/images/rooms/Deluxe/room.jpg',
                                    '/images/rooms/Deluxe/room1.jpg',
                                    '/images/rooms/Deluxe/room2.jpg',
                                    '/images/rooms/Deluxe/room3.jpg',
                                    '/images/rooms/Deluxe/room4.jpg',
                                    '/images/rooms/Deluxe/room5.jpg',
                                    '/images/rooms/Deluxe/room6.jpg'
                                ];
                            } else if (normalizedName === 'standard single') {
                                roomImages = [
                                    '/images/rooms/Standard/room2.jpg',
                                    '/images/rooms/Standard/room1.jpg',
                                    '/images/rooms/Standard/room3.jpg',
                                    '/images/rooms/Standard/room4.jpg'
                                ];
                            }
                        }

                        // Determine image to display (use featured image, first image, or fallback)
                        const imageNum = (index % 2) + 1;
                        const displayImage = roomType.featuredImage || 
                                           (roomImages.length > 0 ? roomImages[0] : null) || 
                                           `/images/room${imageNum === 1 ? '-1' : '2'}.jpg`;
                        
                        // Count of images for badge
                        const imageCount = roomImages.length || Math.floor(Math.random() * 10) + 15;
                    %>
                        <div class="room-container">
                            <div class="room-image room-card-carousel" data-room-id="<%= roomType.id %>" data-images='<%= JSON.stringify(roomImages) %>'>
                                <img src="<%= displayImage %>" alt="<%= roomType.name %>" class="img-fluid rounded" loading="lazy" onerror="this.onerror=null; this.src='/images/room-1.jpg';">
                                <div class="price-overlay"><%= Number(roomType.baseRate).toLocaleString() %> FCFA/night</div>
                                <div class="photo-count-badge">
                                    <i class="fas fa-camera"></i> <%= imageCount %>
                                </div>
                                <button class="carousel-control-prev room-card-prev" type="button">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Previous</span>
                                </button>
                                <button class="carousel-control-next room-card-next" type="button">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Next</span>
                                </button>
                            </div>
                            <div class="room-details" data-price="<%= roomType.baseRate %>" data-room-type-id="<%= roomType.id %>">
                                <div class="room-header">
                                    <h2><%= roomType.name.toUpperCase() %></h2>
                                    <a href="#" class="more-details-link" data-room-type-id="<%= roomType.id %>" data-room-name="<%= roomType.name %>" data-capacity="<%= roomType.capacity %>" data-equipment='<%= JSON.stringify(equipment) %>' data-amenities='<%= JSON.stringify(amenities) %>' data-price="<%= roomType.baseRate %>" data-image-num="<%= imageNum %>">
                                        <span data-i18n="bookNow.moreDetails">More details</span> <i class="fas fa-chevron-right"></i>
                                    </a>
                                </div>
                                <p><i class="fas fa-users icon"></i><strong data-i18n="bookNow.maxOccupancy">Max Occupancy:</strong> <%= roomType.capacity %> <span data-i18n="bookNow.<%= roomType.capacity > 1 ? 'guests' : 'guest' %>">Guest<%= roomType.capacity > 1 ? 's' : '' %></span></p>
                                
                                <% if (quickEquipment.length > 0) { %>
                                    <p><i class="fas fa-snowflake icon"></i><strong data-i18n="bookNow.equipment">Equipment:</strong> <span class="truncate-content"><%- quickEquipment.map(function(item, index) {
                                        return `<span class="equipment-item">${item}</span>${index < quickEquipment.length - 1 ? '<span class="equipment-comma">, </span>' : ''}`;
                                    }).join('') %></span></p>
                                <% } %>
                                
                                <% if (quickAmenities.length > 0) { %>
                                    <p><i class="fas fa-wifi icon"></i><strong data-i18n="bookNow.amenities">Amenities:</strong> <span class="truncate-content"><%- quickAmenities.map(function(item) {
                                        return `<span>${item}</span>`;
                                    }).join(', ') %></span></p>
                                <% } %>
                                
                                <p><i class="fas fa-money-bill icon"></i><strong data-i18n="bookNow.price">Price:</strong> <%= Number(roomType.baseRate).toLocaleString() %> FCFA<span data-i18n="bookNow.perNight">/night</span></p>
                                
                                <% if (typeof hasAvailabilityData !== 'undefined' && hasAvailabilityData) { %>
                                    <% if (roomType.hasAvailability) { %>
                                        <p class="availability-info" style="color: #28a745;">
                                            <i class="fas fa-check-circle icon"></i><strong data-i18n="bookNow.availability">Availability:</strong> 
                                            <%= roomType.available %> <span data-i18n="bookNow.<%= roomType.available !== 1 ? 'rooms' : 'room' %>">room<%= roomType.available !== 1 ? 's' : '' %></span> <span data-i18n="bookNow.available">available</span>
                                        </p>
                                    <% } else { %>
                                        <p class="availability-info" style="color: #dc3545;">
                                            <i class="fas fa-times-circle icon"></i><strong data-i18n="bookNow.availability">Availability:</strong> 
                                            <span data-i18n="bookNow.notAvailable">No rooms available for selected dates</span>
                                        </p>
                                    <% } %>
                                <% } else { %>
                                    <p><i class="fas fa-bed icon"></i><strong data-i18n="bookNow.totalRooms">Total Rooms:</strong> <%= roomType.totalRooms %> <span data-i18n="bookNow.<%= roomType.totalRooms !== 1 ? 'rooms' : 'room' %>">room<%= roomType.totalRooms !== 1 ? 's' : '' %></span></p>
                                <% } %>
                                                                <div class="room-buttons mt-4">
                                    <% if (typeof hasAvailabilityData !== 'undefined' && hasAvailabilityData) { %>
                                        <% if (roomType.hasAvailability) { %>
                                            <button class="btn btn-primary book-now-btn" data-room-type-id="<%= roomType.id %>" data-room-type-name="<%= roomType.name %>" data-has-availability="true">
                                                <span data-i18n="nav.bookNow">Book Now</span>
                                                <i class="fas fa-arrow-right"></i>
                                            </button>
                                        <% } else { %>
                                            <button class="btn btn-secondary book-now-btn" disabled>
                                                <span data-i18n="bookNow.notAvailable">Not Available</span>
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        <% } %>
                                    <% } else { %>
                                        <button class="btn btn-primary book-now-btn" data-room-type-id="<%= roomType.id %>" data-room-type-name="<%= roomType.name %>" data-has-availability="false">
                                            <span data-i18n="nav.bookNow">Book Now</span>
                                            <i class="fas fa-arrow-right"></i>
                                        </button>
                                        <!-- Warning message (hidden by default, shown when button is clicked) -->
                                        <div class="availability-warning-message" style="display: none; margin-top: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
                                            <i class="fas fa-exclamation-triangle" style="color: #856404; margin-right: 8px;"></i>
                                            <small style="color: #856404;">
                                                <strong>Please check availability first!</strong><br>
                                                Select dates and click "CHECK ROOMS" above.
                                            </small>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="alert alert-warning mt-4">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>No rooms available</strong><br>
                        We're currently updating our room inventory. Please check back later or contact us directly.
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Room Details Modal -->
    <div class="modal fade" id="roomDetailsModal" tabindex="-1" aria-labelledby="roomDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roomDetailsModalLabel">Room Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Image Carousel -->
                    <div id="roomImageCarousel" class="carousel slide" data-bs-ride="false">
                        <div class="carousel-inner" id="carouselImages">
                            <!-- Images will be dynamically inserted here -->
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#roomImageCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#roomImageCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>

                    <!-- Room Details -->
                    <div class="modal-room-details mt-4">
                        <h3 id="modalRoomName" class="mb-3"></h3>
                        <p id="modalRoomSubtitle" class="text-muted"></p>
                        
                        <div class="row mt-4">
                            <!-- Amenities Grid -->
                            <div class="col-md-6">
                                <div class="amenity-item">
                                    <i class="fas fa-snowflake"></i>
                                    <div>
                                        <strong>Climatisation</strong>
                                    </div>
                                </div>
                                <div class="amenity-item" id="reception">
                                    <i class="fas fa-bell"></i>
                                    <div>
                                        <strong>Reception 24/7</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="amenity-item">
                                    <i class="fas fa-utensils"></i>
                                    <div>
                                        <strong>Restaurant/Bar</strong>
                                    </div>
                                </div>
                                <div class="amenity-item">
                                    <i class="fas fa-parking"></i>
                                    <div>
                                        <strong>Parking</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Room Details -->
                        <div class="mt-4 room-details-list">
                            <div class="room-detail-item">
                                <i class="fas fa-expand-arrows-alt"></i>
                                <span>310 sq ft</span>
                            </div>
                            <div class="room-detail-item">
                                <i class="fas fa-users"></i>
                                <span>Sleeps 4</span>
                            </div>
                            <div class="room-detail-item">
                                <i class="fas fa-bed"></i>
                                <span>1 King Bed</span>
                            </div>
                            <div class="room-detail-item">
                                <i class="fas fa-wifi"></i>
                                <span>Free WiFi</span>
                            </div>
                        </div>

                        <!-- Room Amenities Section -->
                        <div class="mt-5">
                            <h4 class="mb-4">Ã‰quipements de la Chambre</h4>
                            
                            <div class="amenities-grid">

                                <!-- Bedroom - Dynamic from amenitiesJson -->
                                <div class="amenity-category mb-4">
                                    <h5 class="amenity-category-title">
                                        <i class="fas fa-bed"></i> Chambre 
                                    </h5>
                                    <ul class="amenity-list" id="modalEquipmentList">
                                        <!-- Will be populated dynamically via JavaScript -->
                                    </ul>
                                </div>

                                <!-- Bathroom - Dynamic from amenitiesJson -->
                                <div class="amenity-category mb-4">
                                    <h5 class="amenity-category-title">
                                        <i class="fas fa-bath"></i> Toilettes
                                    </h5>
                                    <ul class="amenity-list" id="modalAmenitiesList">
                                        <!-- Will be populated dynamically via JavaScript -->
                                    </ul>
                                </div>


                                <!-- Accessibility -->
                                <!-- <div class="amenity-category mb-4">
                                    <h5 class="amenity-category-title">
                                        <i class="fas fa-universal-access"></i> Accessibility
                                    </h5>
                                    <ul class="amenity-list">
                                        <li>Accessible bathtub</li>
                                        <li>Closed captioned TV</li>
                                        <li>Phone accessibility kit</li>
                                    </ul>
                                </div> -->
                                <!-- Entertainment -->
                                <!-- <div class="amenity-category mb-4">
                                    <h5 class="amenity-category-title">
                                        <i class="fas fa-tv"></i> Entertainment
                                    </h5>
                                    <ul class="amenity-list">
                                        <li>40-inch TV</li>
                                    </ul>
                                </div> -->

                                <!-- Food and drink -->
                                <!-- <div class="amenity-category mb-4">
                                    <h5 class="amenity-category-title">
                                        <i class="fas fa-utensils"></i> Food and drink
                                    </h5>
                                    <ul class="amenity-list">
                                        <li>Mini-fridge</li>
                                    </ul>
                                </div> -->

                                <!-- Internet -->
                               <!-- <div class="amenity-category mb-4">
                                    <h5 class="amenity-category-title">
                                        <i class="fas fa-wifi"></i> Internet
                                    </h5>
                                    <ul class="amenity-list">
                                        <li>Free WiFi</li>
                                        <li>Free wired internet</li>
                                    </ul>
                                </div> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include("../partials/footer.ejs") %>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <!-- Utility libraries (load before page scripts) -->
    <script src="/js/lib/utils.js"></script>
    <script src="/js/lib/dates.js"></script>
    <script src="/js/lib/booking.js"></script>
    <script src="/js/lib/flatpickr-helpers.js"></script>
    
    <!-- Pass server defaults to JavaScript -->
    <script>
        window.defaultCheckIn = '<%= defaultCheckIn %>';
        window.defaultCheckOut = '<%= defaultCheckOut %>';
        window.defaultGuests = '<%= defaultGuests %>';   
    </script>
 
    <script src="/js/pages/bookNow.js"></script>
    
    <!-- i18next for translations -->
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.11.5/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.5.2/i18nextHttpBackend.min.js"></script>
    <script src="/js/i18n-client.js"></script>
</body>
</html>
